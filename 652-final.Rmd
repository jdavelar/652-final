---
title: "652-final"
author: "Janette Avelar"
output: html_document
header-includes:
    - \usepackage{animate}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      eval = TRUE,
                      warning = FALSE,
                      error = FALSE,
                      include = FALSE)
```

```{r Load Library}
library(here)
library(tidyverse)
library(janitor)
library(gganimate)
library(gifski)
library(png)
```

```{r Data Import}
here::here("data")
enroll    <-  read_csv(here("data", "lang_enrolls_1958-2016.csv")) %>% 
              clean_names()
region    <-  read_csv(here("data", "lang_region.csv")) %>% 
              clean_names()
geo_code  <-  read_csv(here("data", "geo_codes.csv")) %>% 
              clean_names()
tot_enroll <- read_csv(here("data", "subset_total_enrolls_1970-2016.csv")) %>% 
              clean_names()
ipeds_geo <-  read_csv(here("data", "ipeds_geo.csv")) %>% 
              clean_names()
inst_ic    <- read_csv(here("data", "inst_desc.csv")) %>% 
              clean_names()
```

# Heritage Language Maintenance

### What is a heritage language and why do we need to maintain it?

### How is a heritage language learner different from a second language learner?

### Why does it matter?

### What is the purpose of this project?

The visualizations below are intended to convey information about enrollment trends \n
in higher education institutions for non-English language courses in the United States. \n
The data used was gathered from a Modern Language Association national survey implemented \n
periodically between 1958 and 2016 which gathers information about each individual \n
institution, including languages offered, enrollment numbers, institution type, geographic \n
information, history of the institution's name, and accreditation.

The reason I chose this particular dataset, which does not highlight information about \n
heritage language programs is mainly because that data does not exist on this level. \n
Existing research and existing heritage language programs are limited and suffer a significant \n
challenge in obscurity. Higher education institutions that *do* opt to offer heritage \n
language courses often house them within larger modern language departments as a series of \n
courses taken before moving into advanced language courses with second-language learners, which \n
can significantly limit potential enrollment and interest. How do you pursue a program you \n
don't even know exists?

This presents a few problems. Firstly, we don't have a real idea of how many institutions \n
currently offer any type of heritage language support system(s). Secondly, even when they are \n
present, we don't have an idea of how often they're utilized, what kind of interest they \n
generate among students, what the major goals and interests of current programs are, and \n
what characterizes current heritage language pedagogical practices outside of limited case \n
studies that are not generalizable on their own. 

The hope is that this data offers a starting point. Though we can't make any inferences about \n
heritage learners specifically, what we can understand looking at these enrollment trends \n
are which languages are already showing stable or growing trends enough so that adding additional \n
support systems could be more easily justifiable and implementable. It shows us which geographic \n
areas in the country show significantly higher language learning trends as a way to approach \n
a given area for closer scrutiny. Taking into account the limitations of this data, any sweeping \n generalizations about the types of programs that should or should not be implemented is not a \n
responsible claim to make. Rather, what this data shows us is a starting point from which to argue \n
for further data collection that can help us understand a given institution’s language program \n
needs as reflected by student utilization and motivation. I would argue one potential avenue for \n
research this makes room for is characterizing the student data gathered for potential recruitment \n
efforts. Another would be cross-institutional collaboration between language departments and other \n
departments to create course offerings that supplement student learning in other areas through \n
non-English languages. 


[move this somewhere else] As it relates to the topic of Spanish HLPs, the data is optimistic as it shows \n
that further research into Spanish language programs is not unfounded as SC accounts for such a large \n
portion of LCs.

```{r Neat & Tidy}
# Need to covert geo_code into factor with 6 levels
# First fix those pesky NAs
geo_code[c(1:11), 1] = 1
geo_code[c(12:24), 1] = 2
geo_code[c(25:36), 1] = 3
geo_code[c(37:42), 1] = 4
geo_code[c(43:51), 1] = 5
geo_code[c(52:56), 1] = 6

# Now convert to factor
geo_code$geography_code <- factor(geo_code$geography_code,
                            levels = c(1:6))

# Add column for region name
# geo_code <- geo_code %>% 
#   mutate(region = factor(case_when(1 %in% geography_code ~ "Northeast",
#                                    2 %in% geography_code ~ "Midwest",
#                                    3 %in% geography_code ~ "Southeast",
#                                    4 %in% geography_code ~ "Southwest",
#                                    5 %in% geography_code ~ "Rocky Mountain",
#                                    6 %in% geography_code ~ "Pacific",
#                                    TRUE ~ as.character())))
# I don't know how to figure this out right now. Check back later.
```

### Proposal 1: 
For this visualization I am highlighting enrollment trends for non-English language \n
courses in higher education institutions. The visualization displays a combined total \n
across all surveyed U.S. institutions, including public and private 2-year and 4-year \n
institutions. The top 10 languages for each survey year were ranked, and the aim was \n
to provide an animation that showed how those relationships changed over time, while \n
also emphasizing very clearly how Spanish has, and continues, to dominate enrollment \n
numbers, as Spanish heritage language programs are my specific area of focus.


```{r Viz 1: Language & Time}
# Getting data ready
# First let's get enrollment data narrowed down
ltviz <- enroll %>% 
  select(srvy_year, language, undergrad_total, grad_total) %>% 
  group_by(language, srvy_year) %>% 
  mutate(undergrad_total = sum(undergrad_total, na.rm = TRUE),
         grad_total = sum(grad_total, na.rm = TRUE),
         total = sum(undergrad_total, grad_total, na.rm = TRUE),
         srvy_year = as.numeric(stringr::str_sub(srvy_year, 1, 4))) %>% 
  ungroup() %>% 
  distinct() %>% 
  filter(srvy_year >= 1980) %>% 

# Trying to figure out how to pull the top 10 ranked for each year
# Set up labels for ranking while you're at it

  group_by(srvy_year) %>% 
  mutate(rank = rank(-total),
         value_rel = total/total[rank==1],
         value_lbl = paste0(" ", total)) %>% 
  group_by(language) %>% 
  filter(rank <= 10) %>% 
  ungroup()

# Now let's try to prep the animation

anim <- ggplot(ltviz, aes(rank, group = language)) +
  geom_tile(aes(y = total,
                height = total,
                width = 0.9, fill = language), alpha = 0.6) + # fill = languages in aes
  #scale_fill_brewer(palette = "Set2") + # Some vars are not showing up wtf
  geom_text(aes(y = 0, label = paste(language, " ")),
            vjust = 0.2, hjust = 1, size = 7) +
  geom_text(aes(y = total, label = value_lbl, hjust = 0), size = 7) + 
  coord_flip(clip = "off", expand = TRUE) + # come back to this
  scale_x_reverse() +
  theme_minimal() +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none",
        panel.background = element_blank(),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_line(size = .1, color = "gray"),
        panel.grid.minor.x = element_line(size = .1, color = "gray"),
        plot.title = element_text(family = "Times", size = 40, hjust = 0.5, face = "bold", color = "black", vjust = -1),
        plot.subtitle = element_text(size = 20, hjust = 0.5, face = "italic", color = "black"),
        plot.background = element_blank(),
        plot.margin = margin(1, 4, 1, 8, "cm")) +
  transition_states(srvy_year, transition_length = 4, state_length = 1) + # try different transition length
  ease_aes("sine-in-out") +
  enter_fade() +
  exit_fade() +
  labs(title = "some shit by language: {closest_state}",
       caption = "data Source:")

# The animation
animate(anim, nframes = 350, fps = 25, width = 1200, height = 1000, # nframes = 350 pared down for playing
        renderer = gifski_renderer("viz1.gif"))


# To Do List:
 # - lowercase language text
 # - figure out why some of the languages (Spanish, particularly) are not showing up when using fill
 # - Plot titles and caption
 # - Mess with theme
 # - Try bounce-in-out
 # - Adjust total label so it has commas and is to the right of Spanish block
 # - Decide if going with count or percents, and either way, need punctuation/symbol
 # - ASL label is cut off WTFFFF


# Question for you, reviewer(s):
# Is it easier to understand this animation with a total, or should I opt instead for presenting
# the ranking as a percentage of total language enrollment?
```

![caption](viz1.gif)

### Proposal 2:
For this visualization I aim to create an interactive US map to present current differences in language program enrollment by geographic area. I’d like to incorporate more detailed information when hovering over a given area but am worried this may be at odds with simplifying the information given to the audience. I may decide later on to move in a different direction in order to keep information manageable.

```{r Viz 2: Geography}

```

### Proposal 3:
My starting point for presenting information about institution type will be a simple, but clean, stacked density plot or histogram. One idea I have for presenting changes across time is to create several plots that can be navigated between using a tab that specifies the year.

An alternate idea is to incorporate bubble charts, or a moving bubble graph, which would pull central information about all language enrollment into smaller clusters based on institution or degree type. As in my thinking about presenting geographic information, I am torn here balancing interactivity/fun factor and focus. Below is the simple line graph previously created with the data. One thing I wanted to point out with it is that I wasn’t able to present the data how I wanted—as a way to contrast institution type that shows the proportion compared to total enrollment, rather than simply presenting the number of individuals enrolled. Figuring out how to present the information in that manner will be a big consideration in the final product.

```{r Viz 3: Institution Type}
# Figure out how to make an animated Sankey chart using the tot_enroll data with enroll data
# If possible, divide into tabs by region and one for totals. By state with a search function
# would also be super cool, but way outside of the time I have for this assignment.

# First things first
# We need to pare down institutional characteristics dataset

ic <- inst_ic %>% 
  select(unitid, instnm, sector)

# Recode variables in sector col
# Note we are collapsing for-profit and not-for-profit; var is irrelevant for viz
ic$sector[ic$sector == 0] <- "Administrative Unit"
ic$sector[ic$sector == 1] <- "4 Year Public"
ic$sector[ic$sector == 2] <- "4 Year Private"
ic$sector[ic$sector == 3] <- "4 Year Private"
ic$sector[ic$sector == 4] <- "2 Year Public"
ic$sector[ic$sector == 5] <- "2 Year Private"
ic$sector[ic$sector == 6] <- "2 Year Private"
ic$sector[ic$sector == 7] <- "Less than 2 Year Public"
ic$sector[ic$sector == 8] <- "Less than 2 Year Private"
ic$sector[ic$sector == 9] <- "Less than 2 Year Private"
ic$sector[ic$sector == 99] <- NA

# Pare down enroll to state, lang, & geo_code to join with ic
ic_join <- enroll %>% 
  select(nces_id, state, geography_code, srvy_year, all_level_total, term) %>% 
  #filter(srvy_year == 2016) %>% #commenting out to try to make time-lapse
  rename(unitid = nces_id) %>% 
  group_by(unitid) %>% 
  mutate("students" = sum(all_level_total, na.rm = TRUE)) %>% 
  ungroup()

# Join ic and ic_join to get language, sector, and geo data
ic_vdata <- left_join(ic_join, ic, by = "unitid") %>% 
  
  # Drop unnecessary data
  select(-c(5, 6, 8)) %>% 
  filter(sector == "4 Year Public" |
         sector == "2 Year Public" |
         sector == "4 Year Private" |
         sector == "2 Year Private") %>% 
  
  # Collapse duplicate rows
  unique()

# Recode geo_code
ic_vdata$geography_code[ic_vdata$geography_code == 1] <- "Northeast"
ic_vdata$geography_code[ic_vdata$geography_code == 2] <- "Midwest"
ic_vdata$geography_code[ic_vdata$geography_code == 3] <- "Southeast"
ic_vdata$geography_code[ic_vdata$geography_code == 4] <- "Southwest"
ic_vdata$geography_code[ic_vdata$geography_code == 5] <- "Rocky Mountain"
ic_vdata$geography_code[ic_vdata$geography_code == 6] <- "Pacific"

# I'm going to try Sankey chart first, which means I need a column of totals(?)

# NIIIIICE
# Time for a static plot to act as animation base

# Note:
# I am attempting to follow along with a blog post, adjusting for my own data,
# trying to learn how the arguments work and tweaking for my needs/aesthetic
# purposes
# Need to figure out how to cite that


# # Create sigmoid function which will mark movement of points
# sigmoid <- function(x_from, x_to, y_from, y_to, scale = 5, n = 100) {
#   x <- seq(-scale, scale, length = n)
#   y <- exp(x) / (exp(x) + 1)
#   tibble(x = (x + scale) / (scale * 2) * (x_to - x_from) + x_from,
#          y = y * (y_to - y_from) + y_from)
# }
# 
# # Data prep
# n_points <- sum(ic_vdata$students)
# data <- tibble(from = rep(4, n_points),
#                to = sample(1:4, n_points, TRUE),
#                color = sample(c("A", "B"), n_points, TRUE))
# 
# # Visualizing one point
# p <- sigmoid(0, 1, as.numeric(data[2, 1]), as.numeric(data[2, 2]),
#              n = 100, scale = 10) %>%
#   mutate(time = row_number()) %>%
#   ggplot(aes(x, y, frame = time)) +
#   geom_point() +
#   transition_states(time, transition_length = 4, state_length = 1) + # try different transition length
#   ease_aes("sine-in-out") +
#   enter_fade() +
#   exit_fade()
# 
# # animate
# gganimate(p)
# 
# animate(p, nframes = 350, fps = 25, width = 1200, height = 1000,
#         renderer = gifski_renderer("viz3.gif"))
# 
# # Trying multiple points
# p <- map_df(seq_len(nrow(data)), 
#     ~ sigmoid(0, 1, as.numeric(data[.x, 1]), as.numeric(data[.x, 2])) %>%
#       mutate(time = row_number() + .x,
#              y = y + runif(1, -0.25, 0.25))) %>%
#   ggplot(aes(x, y, frame = time)) +
#   geom_point() +
#   transition_states(time, transition_length = 4, state_length = 1) + # try different transition length
#   ease_aes("sine-in-out") +
#   enter_fade() +
#   exit_fade()
# 
# animate(p, nframes = 350, fps = 25, width = 1200, height = 1000,
#         renderer = gifski_renderer("viz3.gif"))


# Scratch all that-- IT'S NOT WORKING



# Let's try geom_jitter across years
viz3 <- ggplot(ic_vdata, aes(sector, students, group = sector)) +
          geom_jitter(aes(color = sector),
                      legend = FALSE) +
          transition_states(srvy_year, transition_length = 4, state_length = 1) + # need to slow down transition
          ease_aes("bounce-in-out") +
          enter_fade() +
          exit_fade() +
    labs(title = "Enrollment Across Institution Type: {closest_state}",
         subtitle = "1958-2016",
       caption = "data Source:")

animate(viz3, nframes = 50, fps = 25, width = 1200, height = 1000, #nframes
        renderer = gifski_renderer("viz3.gif"))

# To Do:
 # - Figure out transition speed - looks odd
 # - Figure out if it's possible to have dots rep n, not just plot n
 # - Paths for plots? Idk, maybe give up on that idea.
 # - Labels
 # - All the aesthetics -- it's pretty ugly right now
 # - Potentially a language dimension? Color by that rather than sector which is not doing much.
 # - Annotations -- total count in plot title with year would be cool. Also percentage maybe of enrollments across type?
 # - Play with dotplot more, really seems more ideal but just cannot figure that geom out.
 # - Is interactivity too ambitious? Probably.

```

